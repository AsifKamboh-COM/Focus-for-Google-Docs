<link rel="stylesheet" href="./pomodoro.css">
<link rel="stylesheet" href="./focus.css">


<!-- BEGIN Focus HTML -->
<div id="focus__app">
    <!-- pomo timer -->
    <div id="focus__pomodoro-container">
        <svg id="focus__pomodoro" viewbox="0 0 100 100"> <!-- rotate so time starts upright -->
            <g id="focus__background"> <!-- light color (always full) -->
                <!-- border (slightly larger and underneath) -->
                <path id="focus__background-border-top" d="M 10 50 A 40 40 0 0 1 90 50" stroke="#5e73ab" stroke-width='11px' fill="#fafafa" stroke-dashoffset="251.4" stroke-dasharray="0 251.4 0"/>
                <path id="focus__background-border-bottom" d="M 10 50 A 40 40 0 0 0 90 50" stroke="#5e73ab" stroke-width='11px' fill="#fafafa" stroke-dashoffset="251.4" stroke-dasharray="0 251.4 0"/>
                
                <!-- background light color -->
                <path id="focus__background-top" d="M 10 50 A 40 40 0 0 1 90 50" stroke="#d4daeb" stroke-width='10px' fill="transparent" stroke-dashoffset="251.4" stroke-dasharray="0 251.4 0"/>
                <path id="focus__background-bottom" d="M 10 50 A 40 40 0 0 0 90 50" stroke="#d4daeb" stroke-width='10px' fill="transparent" stroke-dashoffset="251.4" stroke-dasharray="0 251.4 0"/>
            </g>
            <g id="focus__foreground"> <!-- darker color overlay (starts at zero) -->
                <path id="focus__top-arc"    d="M 10 50 A 40 40 0 0 1 90 50" stroke-width='10px' fill="transparent" stroke-dashoffset="0" stroke-dasharray="0 251.4 0"/>
                <path id="focus__bottom-arc" d="M 10 50 A 40 40 0 0 0 90 50" stroke-width='10px' fill="transparent" stroke-dashoffset="0" stroke-dasharray="0 251.4 0"/>
            </g>
    
            <g id="focus__status-dependent">
                <!-- Start of timer -->
                <!-- Normal text: Focus -->
                <g id='focus__focus-text' class="focus__hidden">
                    <text x="50" y="56" text-anchor="middle" font-size="23px" font-family="helvetica">Focus</text>
                </g>
                
                <!-- Hovered text: Click to focus -->
                <g id='focus__click-to-focus-text' class="focus__hidden">
                    <text x="50" y="48" text-anchor="middle" font-size="20px" font-family="helvetica">Click to</text>
                    <text x="50" y="69" text-anchor="middle" font-size="20px" font-family="helvetica">focus</text>
                </g>

                <!-- Hovered text: Click to unfocus -->
                <g id='focus__click-to-unfocus-text' class="focus__hidden">
                    <text x="50" y="47" text-anchor="middle" font-size="18px" font-family="helvetica">Click to</text>
                    <text x="50" y="64" text-anchor="middle" font-size="18px" font-family="helvetica">unfocus</text>
                </g>

                <!-- Option key triggered logo: Fullscreen -->
                <g id='focus__fullscreen-logo' class="focus__hidden">
                    <path d="M 30 59.5 L 22 59.5 L 22 79.5 L 42 79.5 L 42 71.5 L 30 71.5 L 30 59.5 L 30 59.5 Z M 22 43.5 L 30 43.5 L 30 31.5 L 42 31.5 L 42 23.5 L 22 23.5 L 22 43.5 L 22 43.5 Z M 70 71.5 L 58 71.5 L 58 79.5 L 78 79.5 L 78 59.5 L 70 59.5 L 70 71.5 L 70 71.5 Z M 58 23.5 L 58 31.5 L 70 31.5 L 70 43.5 L 78 43.5 L 78 23.5 L 58 23.5 L 58 23.5 Z" />
                    <!-- x translate 22 y translate 23.5 -->
                </g>
                <g id='focus__exit-fullscreen-logo' class="focus__hidden">
                    <path d="M 22 67.5 L 34 67.5 L 34 79.5 L 42 79.5 L 42 59.5 L 22 59.5 L 22 67.5 L 22 67.5 Z M 34 35.5 L 22 35.5 L 22 43.5 L 42 43.5 L 42 23.5 L 34 23.5 L 34 35.5 L 34 35.5 Z M 58 79.5 L 66 79.5 L 66 67.5 L 78 67.5 L 78 59.5 L 58 59.5 L 58 79.5 L 58 79.5 Z M 66 35.5 L 66 23.5 L 58 23.5 L 58 43.5 L 78 43.5 L 78 35.5 L 66 35.5 L 66 35.5 Z" />
                </g>

                <!-- End of timer -->
                <!-- Stroke and fill styled in CSS so consistent color theme with var(--FOCUS__*) -->
                <g id="focus__smiley-face" class="focus__hidden">
                    <circle cx="40" cy="40" r='4' />
                    <circle cx="60" cy="40" r='4' />
                    <path d="M 30 60 A 20 10 0 0 0 70 60" stroke-width="3" />
                </g>
            </g>
    
            <text id='focus__time-left-text' x="50" y="61" text-anchor="middle" font-size="40px" font-family="helvetica" /> <!-- time left innerText value inserted by JS -->
        </svg>
    </div>

    <input type="number" min="0" max="9999" id="focus__time-left-editable" class="focus__hidden" />
    <div id="focus__finish-editing-time-left" class="focus__hidden">
        <svg height="17px" viewBox="0 0 512 512" width="17px">
            <path fill="white" d="M461.6,109.6l-54.9-43.3c-1.7-1.4-3.8-2.4-6.2-2.4c-2.4,0-4.6,1-6.3,2.5L194.5,323c0,0-78.5-75.5-80.7-77.7  c-2.2-2.2-5.1-5.9-9.5-5.9c-4.4,0-6.4,3.1-8.7,5.4c-1.7,1.8-29.7,31.2-43.5,45.8c-0.8,0.9-1.3,1.4-2,2.1c-1.2,1.7-2,3.6-2,5.7  c0,2.2,0.8,4,2,5.7l2.8,2.6c0,0,139.3,133.8,141.6,136.1c2.3,2.3,5.1,5.2,9.2,5.2c4,0,7.3-4.3,9.2-6.2L462,121.8  c1.2-1.7,2-3.6,2-5.8C464,113.5,463,111.4,461.6,109.6z" />
        </svg>
    </div>

    <!-- hover overlays -->
    <div id="focus__start-hover" class='focus__hidden'>
        <div id="focus__start-hover-children">
            <div id='focus__done-with-break-message' class='focus__hidden'>Break&apos;s over</div>
            <div>
                <input type="number" min="0" max="9999" id='focus__minutes' value="20" style='width: 6ch' />
                <label for="focus__minutes">minutes</label>
            </div>
            <button id="focus__start-btn" class="focus__btn">Start</button>
        </div>
        <svg id="focus__start-hover-triangle" width="50px" height="25px" viewbox="0 0 50 10">
            <path d="M 18 0 L 25 10, 32 0" stroke="#ccc" stroke-width="2" fill="#fafafa" />
        </svg>
    </div>

    <div id="focus__middle-hover" class="focus__hidden"> <!-- 'running' or 'paused' -->
        <svg id="focus__middle-hover-status" class="focus__btn" viewbox="10 10 80 80" width="20px" height="20px">
            <g id="focus__running-icon" class="focus__hidden">
                <rect x="33" y="30" width="12" height="40" rx="2" fill="#111" />
                <rect x="53" y="30" width="12" height="40" rx="2" fill="#111" />
            </g>
            <g id="focus__paused-icon" class="focus__hidden">
                <polygon points="36 30, 36 70, 73 50" fill='#111' />
            </g>
        </svg>
        <div id="focus__middle-hover-more-btn" class="focus__btn" style='display: flex; align-items: start; justify-content: center;'>
            <div style='font-size: 1.2em; font-weight: bold; position: relative; bottom: 4px;'>...</div>
        </div>

        <div id='focus__more-dropdown-container'>
            <div id='focus-enter-focus-mode-btn' class='focus__more-dropdown-item first' style='min-width: 140px'>
                <svg id='enter-focus-mode-svg-icon' width="20" height="20" viewBox="0 0 150 150" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M55.6121 125.008H96.4019C98.9346 125.008 104 126.542 104 132.679C104 138.816 98.9346 140.094 96.4019 139.967H55.6121C52.9461 140.222 47.6941 139.123 48.014 132.679C48.3339 126.235 53.2127 124.88 55.6121 125.008Z" fill="#D9D9D9" stroke="black" stroke-width="2"/> <path d="M55.4762 112.007H95.5376C98.0251 112.007 103 113.439 103 119.167C103 124.895 98.0251 126.088 95.5376 125.969H55.4762C52.8578 126.207 47.6995 125.181 48.0137 119.167C48.3279 113.153 53.1196 111.888 55.4762 112.007Z" fill="#D9D9D9" stroke="black" stroke-width="2"/> <path d="M55.4762 99.008H95.5376C98.0251 99.008 103 100.542 103 106.679C103 112.816 98.0251 114.094 95.5376 113.967H55.4762C52.8578 114.222 47.6995 113.123 48.0137 106.679C48.3279 100.235 53.1196 98.8801 55.4762 99.008Z" fill="#D9D9D9" stroke="black" stroke-width="2"/> <path d="M111.498 32.3059C106.549 6.50998 87.0409 9.16258 75 9.01852C62.9591 9.16258 43.4507 6.50998 38.5023 32.3059C33.5268 58.2425 34.1487 60.3598 38.5023 74.6514C42.8558 82.5911 52.5946 83.1205 52.5946 90.0016V99H74.8037H75.1963H97.4054V90.0016C97.4054 83.1205 107.144 82.5911 111.498 74.6514C115.851 60.3598 116.473 58.2425 111.498 32.3059Z" fill="#E8C032"/> <path d="M74.8037 9.01591C86.8277 9.19235 106.522 6.36933 111.498 32.3059C116.473 58.2425 115.851 60.3598 111.498 74.6514C107.144 82.5911 97.4054 83.1205 97.4054 90.0016V99H74.8037M75.1963 9.01591C63.1723 9.19235 43.4777 6.36933 38.5023 32.3059C33.5268 58.2425 34.1487 60.3598 38.5023 74.6514C42.8558 82.5911 52.5946 83.1205 52.5946 90.0016V99H75.1963" stroke="black" stroke-width="2"/> <path d="M85.6096 98.5151V83.9696C87.7072 82.5151 91.9023 81.0605 92.8704 74.7575C93.3856 71.403 92.3864 66.0302 89.482 66.515C86.5777 66.9999 83.6734 69.909 83.6734 72.3333C83.6734 74.7575 85.6096 76.6969 87.0618 77.1818C88.5139 77.6666 89.9661 62.6363 81.7372 64.5757C73.5084 66.515 73.0243 71.8484 74.9605 75.2423C76.5095 77.9575 78.8329 76.3737 79.801 75.2423C79.1556 70.3939 76.6063 61.4726 71.5722 64.5757C65.2795 68.4544 63.3433 69.909 65.2795 74.7575C66.8285 78.6363 68.8292 76.6969 69.636 75.2423C69.636 70.0706 68.571 60.5029 64.3114 63.606C58.9868 67.4848 58.5028 67.4847 58.0187 70.3938C57.6315 72.7211 63.3433 80.5757 66.2476 82.5151L66.2476 99" stroke="#742C1C" stroke-width="2"/> <path d="M103.236 26.6517C102.692 32.8241 95.9412 37.2713 88.1586 36.5849C80.376 35.8984 73.7508 27.8229 74.2953 21.6505C74.8397 15.4781 82.3476 13.5461 90.1302 14.2326C97.9128 14.9191 103.781 20.4793 103.236 26.6517Z" fill="url(#paint0_radial_1_15)" fill-opacity="0.3"/> <rect x="28.4595" y="77.706" width="10" height="29" rx="5" transform="rotate(52.4987 28.4595 77.706)" fill="#FAD861"/> <rect x="29.8189" y="55" width="10" height="29" rx="5" transform="rotate(83.5942 29.8189 55)" fill="#FAD861"/> <rect x="35.0395" y="30.8125" width="10" height="29" rx="5" transform="rotate(120.716 35.0395 30.8125)" fill="#FAD861"/> <rect width="10" height="29" rx="5" transform="matrix(-0.608779 0.79334 0.79334 0.608779 120.58 77.706)" fill="#FAD861"/> <rect width="10" height="29" rx="5" transform="matrix(-0.111569 0.993757 0.993757 0.111569 119.221 55)" fill="#FAD861"/> <rect width="10" height="29" rx="5" transform="matrix(0.510776 0.859714 0.859714 -0.510776 114 30.8125)" fill="#FAD861"/> <defs> <radialGradient id="paint0_radial_1_15" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(88.6585 25.3659) rotate(90) scale(12.1951 15.9067)"> <stop stop-color="white"/> <stop offset="1" stop-color="white" stop-opacity="0.2"/> </radialGradient> </defs> </svg>
                Enter focus
            </div>
            <div id='focus-exit-focus-mode-btn' class='focus__more-dropdown-item first'>
                <svg width="20" height="20" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"> <rect width="50" height="50" /> <path d="M18 10H44V41H18" stroke="black" stroke-width="5"/> <path d="M31.5 25.5H7M7 25.5L12.5 31M7 25.5L12.5 20" stroke="black" stroke-width="5"/> </svg>
                Exit focus
            </div>
            <div id='focus-enter-fullscreen-btn' style='min-width: 140px' class='focus__more-dropdown-item'>
                <svg width="20" height="20" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"> <rect width="50" height="50" /> <path d="M6 21V6H21" stroke="black" stroke-width="5"/> <path d="M6 28V43H21" stroke="black" stroke-width="5"/> <path d="M44 21V6H29" stroke="black" stroke-width="5"/> <path d="M44 28V43H29" stroke="black" stroke-width="5"/> </svg>
                Enter fullscreen
            </div>
            <div id='focus-exit-fullscreen-btn' style='min-width: 130px' class='focus__more-dropdown-item'>
                <svg width="20" height="20" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"> <rect width="50" height="50" /> <path d="M19 3V19H3" stroke="black" stroke-width="5"/> <path d="M19 46V30H3" stroke="black" stroke-width="5"/> <path d="M30 3V19H46" stroke="black" stroke-width="5"/> <path d="M30 46V30H46" stroke="black" stroke-width="5"/> </svg>
                Exit fullscreen
            </div>
            <div id='focus-stop-timer-btn' class='focus__more-dropdown-item'>
                <svg width="20" height="20" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"> <rect width="50" height="50" /> <path d="M7.5 7L41 40.5" stroke="black" stroke-width="5"/> <path d="M41 7L7.5 40.5" stroke="black" stroke-width="5"/> </svg>
                Stop timer
            </div>
            <div id='focus-restart-timer-btn' class='focus__more-dropdown-item last'>
                <svg width="20" height="20" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"> <rect width="50" height="50" /> <path d="M28.1365 10.5487C31.6117 11.4799 34.6716 13.5551 36.8222 16.4394C38.9728 19.3236 40.0886 22.8485 39.9893 26.4448C39.8901 30.0412 38.5817 33.4992 36.2753 36.2605C33.9689 39.0217 30.7992 40.9251 27.278 41.6632C23.7568 42.4013 20.0895 41.9311 16.8684 40.3285C13.6473 38.726 11.0603 36.0845 9.52513 32.8308C7.98996 29.577 7.59622 25.9008 8.40749 22.3957" stroke="black" stroke-width="5"/> <path d="M38.7942 5.49998L26.5 8.79421L29.7942 21.0884" stroke="black" stroke-width="5"/> </svg>
                Restart timer
            </div>
        </div>
        <div id='focus__more-dropdown-container-helpers'>
            <div id='focus__more-dropdown-triangle'></div>
            <div id='focus__more-dropdown-triangle-outer'></div>
            <div id='focus__more-dropdown-box-underneath'></div>
        </div>
    </div>

    <!-- ending message -->
    <div id="focus__done-message" class='focus__done-message-container focus__hidden'>
        <div class="focus__done-message-wrapper">
            <svg viewBox="0 0 120 75" class='focus__done-message-dialog-box'>
                <polygon
                    points="
                        2 2, 118 2,
                        118 70, 95 70, 85 80, 75 70, 2 70
                    "
                    stroke="#ccc"
                    stroke-width="2px"
                    fill="#fafafa"
                />
            </svg>
            <div class="focus__done-message-content-wrapper">
                <div style='text-align: center; margin-block: 3px;'>Nice job!</div>
                <button id='focus__start-break-button' class='focus__btn'>Take a <span id='focus__break-duration'>5 min</span> break</button>
                <button id='focus__skip-break-button' class='focus__btn'>Skip break</button>
            </div>
        </div>
    </div>
</div>
<!-- END Focus HTML -->


<script>
    'use strict';

    // Configuration
    const ENV='dev';
    // const ENV='prod';
    
    const THEME={ //color theme
        DARKGRAY: '#444',
        GRAY: '#ccc',
        WHITE: '#fafafa',
        BLUE: 'royalblue',
        GREEN: '#00943c'
    };
    
    let isBreak=false;
    
    //# SVG API
    const $i=query=>document.getElementById(query);
    const $i_show=query=>$i(query).classList.remove('focus__hidden');
    const $i_hide=query=>$i(query).classList.add('focus__hidden');
    const devPrint=(...args)=>{ if (ENV==='dev') console.log('', ...args) }; //avoid printing during production
    const prodPrint=(...args)=>console.log('<Focus>', ...args); //prints during development and production showing watermark

    const circumference=Math.PI*2*40; //251.4
    const pomodoroEl=$i('focus__pomodoro');
    const topEl=$i('focus__top-arc'); //foreground
    const bottomEl=$i('focus__bottom-arc');
    const textEl=$i('focus__time-left-text');
    const editableTextEl=$i('focus__time-left-editable');
    const uMinutesEl=$i('focus__minutes'); //user's input for minutes
    const checkmarkEl=$i('focus__finish-editing-time-left');

    function setCompletePercent(percent /** out of 100 */) {
        const scaledAmount=percent/100*circumference;
        topEl.style.strokeDashoffset=(-scaledAmount).toString();
        bottomEl.style.strokeDashoffset=scaledAmount.toString();
    }

    //# Timer Utils
    let pausedStartedAt=-1; //-1 (not paused) or unix time (paused)
    let startTime;
    let endTime;
    let clockInterval;

    function runTimer(durationMinutes) {
        startTime=Date.now(); //in millis (unix time)
        endTime=Date.now()+durationMinutes*60*1000; //in millis
        const millisDuration=endTime-startTime;

        function updateClock() { //compute logic & render DOM
            const millisPassed=Date.now()-startTime;
            const percentComplete=millisPassed/millisDuration*100;
            const minutesLeft=(endTime-Date.now())/1000/60;

            if (minutesLeft<0)
                return setTimerComplete();

            if (minutesLeft>=1) //display minutes left
                textEl.innerHTML=Math.floor(minutesLeft).toString();

            if (minutesLeft<1 && minutesLeft>0) { //display seconds left
                let secondsLeft=Math.floor(minutesLeft*60).toString();
                while (secondsLeft.length<2) //make sure at least two digits
                    secondsLeft='0'+secondsLeft;
                
                textEl.style.fontSize='30px';
                textEl.innerHTML='0:'+secondsLeft;
            }

            setCompletePercent(percentComplete);
        }
        
        updateClock();
        clockInterval=setInterval(()=>{
            if (pausedStartedAt===-1)
                updateClock();
        }, 100);
    }

    function killClock() { //resets clock like starting state
        clearInterval(clockInterval);
        clockInterval=-1;
        pausedStartedAt=-1;
        setCompletePercent(0);
        textEl.innerHTML='';
    }

    function resetClockStyling() {
        // // Color
        // topEl.style.stroke=THEME.BLUE;
        // bottomEl.style.stroke=THEME.BLUE;

        $i('focus__background-border-top').style.stroke='#5e73ab';
        $i('focus__background-border-bottom').style.stroke='#5e73ab';

        $i('focus__background-top').style.stroke='#d4daeb';
        $i('focus__background-bottom').style.stroke='#d4daeb';
        
        // Width
        uMinutesEl.style.width='6ch';
    }

    function setTimerComplete() { //sets timer complete (green)
        killClock();
        setCompletePercent(100);
        textEl.innerHTML='';
        // topEl.style.stroke=THEME.GREEN;
        // bottomEl.style.stroke=THEME.GREEN;
        if (isBreak) {
            setStatus('done-with-break');
            setIsBreak(false);
        } else {
            setStatus('done');
        }
        if (settings.exitFocusModeOnTimerEnd)
            setFocusStatus('off');
    }

    function hideAll() { //hides all status-dependent elements
        [
            'focus__start-hover',
            'focus__middle-hover',
            'focus__focus-text',
            'focus__time-left-editable',
            'focus__running-icon',
            'focus__paused-icon',
            'focus__smiley-face',
            'focus__finish-editing-time-left',
            'focus__done-message',
            'focus__done-with-break-message'
        ].forEach($i_hide);
    }
    
    function setText(text) {
        ['focus__focus-text', 'focus__click-to-focus-text', 'focus__click-to-unfocus-text', 'focus__exit-fullscreen-logo', 'focus__fullscreen-logo']
            .forEach($i_hide);
        if (status==='start' || status==='done')
            $i_show(text);
    }
    
    function setIsBreak(newIsBreak) {
        isBreak=newIsBreak;
        if (newIsBreak)
            pomodoroEl.classList.add('focus__break-mode');
        else
            pomodoroEl.classList.remove('focus__break-mode');
    }
    
    function addEventListeners() { // adds event listeners to elements
        //# Mouseup
        // For start
        $i('focus__start-btn').addEventListener('mouseup', startTimer);
        function startTimer() {
            setIsBreak(false);
            resetClockStyling();
            runTimer(uMinutesEl.value);
            setStatus('running');
        }
        uMinutesEl.addEventListener('input', e=>{
            const inputNumChars=uMinutesEl.value.length || 1; //change width to match input size
            uMinutesEl.style.width=`${inputNumChars+5}ch`;
            document.querySelector('label[for="focus__minutes"]').innerHTML=e.target.value==='1' ? 'minute' : 'minutes'; //minute or minutes reflects u_input
        });
        uMinutesEl.addEventListener('keypress', e=>{
            if (e.key==='Enter') //finished because hit enter key
                startTimer();
        });

        // Option key changes the logo to fullscreen or exit fullscreen button
        const showFullScreenOrNot=showFocusUnfocus=>e=>{
            if (e.altKey)
                if (document.fullscreenElement==null)
                    setText('focus__fullscreen-logo');
                else
                    setText('focus__exit-fullscreen-logo');
            else
                if (showFocusUnfocus)
                    if (focusStatus==='on')
                        setText('focus__click-to-unfocus-text');
                    else if (focusStatus==='off')
                        setText('focus__click-to-focus-text');
                else
                    setText('focus__focus-text');
        };
        document.addEventListener('keydown', showFullScreenOrNot(false));
        document.addEventListener('keyup', e=>e.key==='Alt' && setText('focus__focus-text'));
        pomodoroEl.addEventListener('keydown', showFullScreenOrNot(true));
        pomodoroEl.addEventListener('keyup', e=>e.key==='Alt' && setText('focus__focus-text'));
        

        // For middle
        // Editing time left (click on time)
        let isEditingTimeLeft=false;
        function setIsEditingTimeLeft(newIsEditingTimeLeft) {
            isEditingTimeLeft=newIsEditingTimeLeft;
            hideAll();
            if (isEditingTimeLeft) { //start editing time left. pause for now
                textEl.classList.add('focus__hidden');
                // start with current timer value
                const currValue=textEl.innerHTML;
                if (currValue.includes(':'))
                    editableTextEl.value=currValue.split(':')[0]+1; //just minutes
                else
                    editableTextEl.value=currValue;
                
                editableTextEl.classList.remove('focus__hidden');
                pausedStartedAt=Date.now(); //start pausing
                editableTextEl.focus();
                $i_show('focus__finish-editing-time-left');
            } else { //done editing time left
                const newValue=editableTextEl.value;
                textEl.classList.remove('focus__hidden');
                editableTextEl.classList.add('focus__hidden');

                const ogDuration=(endTime-startTime)/60/1000; //minutes left
                const newMinutesLeft=+editableTextEl.value;
                $i_hide('focus__finish-editing-time-left');

                if (newMinutesLeft>ogDuration) { //increased time left beyond original
                    startTime=Date.now(); //start from now
                    endTime=Date.now()+newValue*60*1000; //user's input minutes ahead of now
                    pausedStartedAt=-1;
                } else { //modified time left below original duration. need to shift time over to change amount of time until endTime
                    // Account for paused time
                    startTime+=Date.now()-pausedStartedAt;
                    endTime+=Date.now()-pausedStartedAt;
                    pausedStartedAt=-1;

                    // Shift time over
                    const ogTimeLeft=endTime-Date.now(); //in millis
                    const newTimeLeft=newMinutesLeft*60*1000; //in millis
                    const shiftOverAmount=newTimeLeft-ogTimeLeft;
                    startTime+=shiftOverAmount;
                    endTime+=shiftOverAmount;
                    setStatus('running');
                }
            }
        }
        
        textEl.addEventListener('mouseup',e=>{
            if (e.altKey) { //don't edit time left if alt key is pressed. Instead, toggle fullscreen
                // Toggle fullscreen
                if (document.fullscreenElement==null) //if not full screen
                    document.body.requestFullscreen();
                else
                    document.exitFullscreen();
            } else {
                setIsEditingTimeLeft(true);
            }
        });
        editableTextEl.addEventListener('keypress', e=>{
            if (e.key==='Enter') //finished because hit enter key
                setIsEditingTimeLeft(false);
        });
        $i('focus__finish-editing-time-left').addEventListener('click', ()=>{ //clicking checkmark causes to be finished editing time
            setIsEditingTimeLeft(false);
        });

        //     running
        $i('focus__middle-hover-status').addEventListener('mouseup', ()=>{
            if (status==='running')
                setStatus('paused');
            else if (status==='paused') {
                const pausedForMillis=Date.now()-pausedStartedAt;
                startTime+=pausedForMillis;
                endTime+=pausedForMillis;
                pausedStartedAt=-1; //resume
                setStatus('running');
            }
        });

        //     selected from more options drop down
        $i('focus-enter-fullscreen-btn').addEventListener('mouseup', ()=>{
            document.body.requestFullscreen();
            setTimeout(updateMoreOptionsDropdownItems, 500);
        });
        $i('focus-exit-fullscreen-btn').addEventListener('mouseup', ()=>{
            document.exitFullscreen();
            setTimeout(updateMoreOptionsDropdownItems, 500);
        });
        $i('focus-stop-timer-btn').addEventListener('mouseup', ()=>{
            killClock();
            setStatus('start');
        });

        $i('focus-restart-timer-btn').addEventListener('mouseup', ()=>{
            killClock();
            runTimer(uMinutesEl.value);
            setStatus('running');
        });
        $i('focus-enter-focus-mode-btn').addEventListener('mouseup', ()=>{
            setFocusStatus('on');
            setTimeout(updateMoreOptionsDropdownItems, 100);
        });
        $i('focus-exit-focus-mode-btn').addEventListener('mouseup', ()=>{
            setFocusStatus('off');
            setTimeout(updateMoreOptionsDropdownItems, 500);
        });
        $i('focus__skip-break-button').addEventListener('mouseup', ()=>{
            setStatus('start');
            $i_show('focus__start-hover');
        });


        
        // end (done)
        $i('focus__start-break-button').addEventListener('mouseup', ()=>{
            runTimer(settings.breakDuration);
            setIsBreak(true);
            setStatus('running');
        });

        
        //# Hover
        pomodoroEl.addEventListener('mouseenter', e=>{
            showFullScreenOrNot(true)(e);

            if (!isEditingTimeLeft && (status==='running' || status==='paused'))
                $i_show('focus__middle-hover');
            
            if (status==='start' || status==='done-with-break') { //ready to start
                $i_show('focus__start-hover');
            } else if (status==='running') { //in the middle
                $i_show('focus__running-icon');
            } else if (status==='paused') { //in the middle
                $i_show('focus__paused-icon');
            } else if (status==='done') { //finished a session
                $i_show('focus__done-message');
            } else if (status==='done-with-break') {
                
            } else {
                throw new Error(`Invalid timer status: ^${status}$`);
            }
        });
        $i('focus__middle-hover-more-btn').addEventListener('mouseenter', ()=>{
            $i_show('focus__more-dropdown-container');
            $i_show('focus__more-dropdown-container-helpers');

            // Make sure correct items shown
            updateMoreOptionsDropdownItems();
        });

        //# Mouse Leave
        $i('focus__app').addEventListener('mouseleave', mouseLeaveHandler);

        function mouseLeaveHandler() {
            setText('focus__focus-text');
            // Hide all hover overlays
            [
                'focus__start-hover',
                'focus__middle-hover',
                'focus__done-message',
                'focus__done-with-break-message',
                'focus__smiley-face',
                'focus__more-dropdown-container',
                'focus__more-dropdown-container-helpers',
            ].forEach($i_hide);
            
            // if (status==='done-with-break')
            //     setStatus('start');
        }
    }
    
    function updateMoreOptionsDropdownItems() {
        if (focusStatus==='on') {
            $i_hide('focus-enter-focus-mode-btn');
            $i_show('focus-exit-focus-mode-btn');
        } else {
            $i_show('focus-enter-focus-mode-btn');
            $i_hide('focus-exit-focus-mode-btn');
        }
        if (document.fullscreenElement==null) {
            $i_show('focus-enter-fullscreen-btn');
            $i_hide('focus-exit-fullscreen-btn');
        } else {
            $i_hide('focus-enter-fullscreen-btn');
            $i_show('focus-exit-fullscreen-btn');
        }
    }
    
    //# Timer Main
    let status='start';
    
    function setStatus(newStatus) { //update DOM to match status
        status=newStatus;
        devPrint('Setting status to', status);
        hideAll();
        
        if (status==='start') {
            resetClockStyling();
            setCompletePercent(0);
            $i_show('focus__focus-text');
        } else if (status==='running') { //in the middle
            pausedStartedAt=-1; //not paused
        } else if (status==='paused') { //in the middle
            pausedStartedAt=Date.now();
        } else if (status==='done') { //finished a session
            $i_show('focus__smiley-face');
            $i_show('focus__done-message');
        } else if (status==='done-with-break') { //finished a session
            $i_show('focus__focus-text');
            $i_show('focus__start-hover');
            $i_show('focus__done-with-break-message');
        } else {
            throw new Error(`Invalid timer status: ^${status}$`);
        }
    }

    function main() {
        $i('focus__break-duration').innerText=`${settings.breakDuration} min`;
        addEventListeners();
        $i_hide('focus__more-dropdown-container');
        $i_hide('focus__more-dropdown-container-helpers');
        setStatus('start');
    }

    main();
</script>
